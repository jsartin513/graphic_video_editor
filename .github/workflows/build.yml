name: Build Video Editor

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  build-x64-fat:
    needs: test
    runs-on: macos-14  # Apple Silicon runner (can build x64 via Rosetta 2)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download FFmpeg binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'true'
          TARGET_ARCH: 'x64'
        run: npm run prebuild:x64

      - name: Verify binaries exist
        run: |
          if [ ! -f resources/ffmpeg ] || [ ! -f resources/ffprobe ]; then
            echo "❌ Error: FFmpeg binaries not found in resources/ directory"
            ls -la resources/ || echo "resources/ directory does not exist"
            exit 1
          fi
          echo "✅ FFmpeg binaries found:"
          ls -lh resources/ffmpeg resources/ffprobe
          file resources/ffmpeg resources/ffprobe

      - name: Build for x64 (Intel) - Fat Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'true'
          TARGET_ARCH: 'x64'
        run: npm run build:fat:x64

      - name: Rename x64 files to include architecture suffix
        run: |
          cd dist
          for file in *.dmg *.zip; do
            if [[ -f "$file" && "$file" != *"arm64"* && "$file" != *"x64"* && "$file" != *"fat"* && "$file" != *"lite"* ]]; then
              ext="${file##*.}"
              basename="${file%.*}"
              newname="${basename}-x64-fat.${ext}"
              mv "$file" "$newname" || true
              echo "Renamed $file to $newname"
            fi
          done
          ls -la

      - name: Upload x64 fat artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Video-Merger-x64-fat
          path: |
            dist/*x64*fat*.dmg
            dist/*x64*fat*.zip
          if-no-files-found: error
          retention-days: 30

  build-x64-lite:
    needs: test
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for x64 (Intel) - Lite Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'false'
          TARGET_ARCH: 'x64'
        run: npm run build:x64

      - name: Rename x64 files to include architecture suffix
        run: |
          cd dist
          for file in *.dmg *.zip; do
            if [[ -f "$file" && "$file" != *"arm64"* && "$file" != *"x64"* && "$file" != *"fat"* && "$file" != *"lite"* ]]; then
              newname="${file%.*}-x64-lite.${file##*.}"
              mv "$file" "$newname" || true
              echo "Renamed $file to $newname"
            fi
          done
          ls -la

      - name: Upload x64 lite artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Video-Merger-x64-lite
          path: |
            dist/*x64*lite*.dmg
            dist/*x64*lite*.zip
          if-no-files-found: error
          retention-days: 30

  build-arm64-fat:
    needs: test
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download FFmpeg binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'true'
          TARGET_ARCH: 'arm64'
        run: npm run prebuild:arm64

      - name: Verify binaries exist
        run: |
          if [ ! -f resources/ffmpeg ] || [ ! -f resources/ffprobe ]; then
            echo "❌ Error: FFmpeg binaries not found in resources/ directory"
            ls -la resources/ || echo "resources/ directory does not exist"
            exit 1
          fi
          echo "✅ FFmpeg binaries found:"
          ls -lh resources/ffmpeg resources/ffprobe
          file resources/ffmpeg resources/ffprobe

      - name: Build for arm64 (Apple Silicon) - Fat Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'true'
          TARGET_ARCH: 'arm64'
        run: npm run build:fat:arm64

      - name: Rename arm64 files to include variant suffix
        run: |
          cd dist
          for file in *arm64.dmg *arm64.zip; do
            if [[ -f "$file" && "$file" != *"fat"* && "$file" != *"lite"* ]]; then
              ext="${file##*.}"
              basename="${file%.*}"
              newname="${basename}-fat.${ext}"
              mv "$file" "$newname" || true
              echo "Renamed $file to $newname"
            fi
          done
          ls -la

      - name: Upload arm64 fat artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Video-Merger-arm64-fat
          path: |
            dist/*arm64*fat*.dmg
            dist/*arm64*fat*.zip
          retention-days: 30

  build-arm64-lite:
    needs: test
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for arm64 (Apple Silicon) - Lite Build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_FFMPEG: 'false'
          TARGET_ARCH: 'arm64'
        run: npm run build:arm64

      - name: Rename arm64 files to include variant suffix
        run: |
          cd dist
          for file in *arm64*.dmg *arm64*.zip; do
            if [[ -f "$file" && "$file" != *"fat"* && "$file" != *"lite"* ]]; then
              basename="${file%.*}"
              ext="${file##*.}"
              newname="${basename}-lite.${ext}"
              mv "$file" "$newname" || true
              echo "Renamed $file to $newname"
            fi
          done
          ls -la

      - name: Upload arm64 lite artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Video-Merger-arm64-lite
          path: |
            dist/*arm64*lite*.dmg
            dist/*arm64*lite*.zip
          retention-days: 30
          if-no-files-found: error

  release:
    needs: [build-x64-fat, build-x64-lite, build-arm64-fat, build-arm64-lite]
    runs-on: ubuntu-latest
    # Run on tag pushes OR pushes to main/master
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || (github.event_name == 'workflow_dispatch')
    permissions:
      contents: write  # Required to create releases
      id-token: write  # Required for OIDC token
    
    steps:
      - name: Download x64 fat artifacts
        uses: actions/download-artifact@v4
        with:
          name: Video-Merger-x64-fat
          path: artifacts/x64-fat

      - name: Download x64 lite artifacts
        uses: actions/download-artifact@v4
        with:
          name: Video-Merger-x64-lite
          path: artifacts/x64-lite

      - name: Download arm64 fat artifacts
        uses: actions/download-artifact@v4
        with:
          name: Video-Merger-arm64-fat
          path: artifacts/arm64-fat

      - name: Download arm64 lite artifacts
        uses: actions/download-artifact@v4
        with:
          name: Video-Merger-arm64-lite
          path: artifacts/arm64-lite

      - name: List downloaded artifacts
        run: |
          echo "=== Artifacts structure ==="
          find artifacts -type f -name "*" || echo "No artifacts found"
          echo ""
          echo "=== x64-fat ==="
          ls -la artifacts/x64-fat/ || echo "x64-fat directory not found"
          echo ""
          echo "=== x64-lite ==="
          ls -la artifacts/x64-lite/ || echo "x64-lite directory not found"
          echo ""
          echo "=== arm64-fat ==="
          ls -la artifacts/arm64-fat/ || echo "arm64-fat directory not found"
          echo ""
          echo "=== arm64-lite ==="
          ls -la artifacts/arm64-lite/ || echo "arm64-lite directory not found"

      - name: Determine release tag and name
        id: release
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Use the tag as the release tag
            TAG_NAME="${{ github.ref_name }}"
            RELEASE_NAME="Release ${{ github.ref_name }}"
            IS_PRERELEASE="false"
          else
            # Use commit SHA for push to main
            TAG_NAME="v${{ github.run_number }}-${{ github.sha }}"
            RELEASE_NAME="Build from main (${{ github.sha }} - Run #${{ github.run_number }})"
            IS_PRERELEASE="true"
          fi
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "Tag: ${TAG_NAME}"
          echo "Release name: ${RELEASE_NAME}"
          echo "Prerelease: ${IS_PRERELEASE}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          name: ${{ steps.release.outputs.release_name }}
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
          draft: false
          prerelease: ${{ steps.release.outputs.prerelease }}
          fail_on_unmatched_files: false  # Don't fail if some files are missing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

